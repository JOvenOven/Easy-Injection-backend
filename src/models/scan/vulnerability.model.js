const Joi = require('joi');
const mongoose = require('mongoose');
const debug = require('debug')('easyinjection:models:vulnerability');
const BaseModel = require('../base/BaseModel');
const { buildObject } = require('../base/ModelHelpers');

const vulnerabilitySchema = new mongoose.Schema({
    escaneo_id: { type: mongoose.Schema.Types.ObjectId, ref: 'Scan', required: true },
    tipo_id: { type: mongoose.Schema.Types.ObjectId, ref: 'VulnerabilityType', required: true },
    nivel_severidad_id: { type: mongoose.Schema.Types.ObjectId, ref: 'SeverityLevel', required: true },
    parametro_afectado: { type: String, maxlength: 100 },
    url_afectada: { type: String, maxlength: 255 },
    descripcion: { type: String },
    sugerencia: { type: String },
    referencia: { type: String }
});

const VulnerabilityModel = mongoose.models.Vulnerability || mongoose.model('Vulnerability', vulnerabilitySchema);

class Vulnerability extends BaseModel {
    #escaneo_id; #tipo_id; #nivel_severidad_id; #parametro_afectado; #url_afectada; #descripcion; #sugerencia; #referencia;

    constructor(data = {}) {
        super(data);
        const plainData = data && typeof data.toObject === 'function' ? data.toObject() : data;
        this.#escaneo_id = plainData.escaneo_id;
        this.#tipo_id = plainData.tipo_id;
        this.#nivel_severidad_id = plainData.nivel_severidad_id;
        this.#parametro_afectado = plainData.parametro_afectado;
        this.#url_afectada = plainData.url_afectada;
        this.#descripcion = plainData.descripcion;
        this.#sugerencia = plainData.sugerencia;
        this.#referencia = plainData.referencia;
    }

    get escaneo_id() { return this.#escaneo_id; }
    set escaneo_id(value) { if (!value) throw new Error('El ID del escaneo es obligatorio'); this.#escaneo_id = value; }

    get tipo_id() { return this.#tipo_id; }
    set tipo_id(value) { if (!value) throw new Error('El ID del tipo de vulnerabilidad es obligatorio'); this.#tipo_id = value; }

    get nivel_severidad_id() { return this.#nivel_severidad_id; }
    set nivel_severidad_id(value) { if (!value) throw new Error('El ID del nivel de severidad es obligatorio'); this.#nivel_severidad_id = value; }

    get parametro_afectado() { return this.#parametro_afectado; }
    set parametro_afectado(value) { if (value && value.length > 100) throw new Error('El parámetro afectado no puede exceder 100 caracteres'); this.#parametro_afectado = value; }

    get url_afectada() { return this.#url_afectada; }
    set url_afectada(value) { if (value && value.length > 255) throw new Error('La URL afectada no puede exceder 255 caracteres'); this.#url_afectada = value; }

    get descripcion() { return this.#descripcion; }
    set descripcion(value) { this.#descripcion = value; }

    get sugerencia() { return this.#sugerencia; }
    set sugerencia(value) { this.#sugerencia = value; }

    get referencia() { return this.#referencia; }
    set referencia(value) { this.#referencia = value; }

    getRiskScore(severityLevel, vulnerabilityType) {
        debug('getRiskScore: calculating for severity=%s type=%s', severityLevel?.nombre, vulnerabilityType?.nombre);
        const severityWeights = { 'Crítica': 10, 'Alta': 7, 'Media': 4, 'Baja': 1 };
        const typeMultipliers = { 'SQLi': 1.5, 'XSS': 1.3, 'CSRF': 1.2, 'XXE': 1.4, 'SSTI': 1.5 };
        const baseScore = severityWeights[severityLevel?.nombre] || 4;
        const multiplier = typeMultipliers[vulnerabilityType?.nombre] || 1.0;
        return Math.round(baseScore * multiplier * 10) / 10;
    }

    getPriority(severityLevel) { return { 'Crítica': 1, 'Alta': 2, 'Media': 3, 'Baja': 4 }[severityLevel?.nombre] || 3; }
    isCritical(severityLevel) { return severityLevel?.nombre === 'Crítica'; }
    isHighPriority(severityLevel) { return ['Crítica', 'Alta'].includes(severityLevel?.nombre); }
    getCVSSScore(severityLevel) {
        const cvssRanges = { 'Crítica': { min: 9.0, max: 10.0 }, 'Alta': { min: 7.0, max: 8.9 }, 'Media': { min: 4.0, max: 6.9 }, 'Baja': { min: 0.1, max: 3.9 } };
        const range = cvssRanges[severityLevel?.nombre] || cvssRanges['Media'];
        return (range.min + range.max) / 2;
    }

    getRemediationEffort() { return this.#sugerencia && this.#sugerencia.length > 100 ? 'Alto' : 'Medio'; }
    hasReference() { return Boolean(this.#referencia); }

    static createEmpty(escaneoId) {
        return new Vulnerability({ escaneo_id: escaneoId, tipo_id: null, nivel_severidad_id: null, parametro_afectado: '', url_afectada: '', descripcion: '', sugerencia: '', referencia: '' });
    }

    static validate(vulnerability) {
        return Joi.object({
            escaneo_id: Joi.string().required(),
            tipo_id: Joi.string().required(),
            nivel_severidad_id: Joi.string().required(),
            parametro_afectado: Joi.string().max(100),
            url_afectada: Joi.string().max(255),
            descripcion: Joi.string(),
            sugerencia: Joi.string(),
            referencia: Joi.string()
        }).validate(vulnerability);
    }

    static get Model() { return VulnerabilityModel; }
    static get debug() { return debug; }

    toObject() { return buildObject(this, ['escaneo_id', 'tipo_id', 'nivel_severidad_id', 'parametro_afectado', 'url_afectada', 'descripcion', 'sugerencia', 'referencia']); }
    toDTO(severityLevel, vulnerabilityType) {
        return { 
            id: this._id,
            _id: this._id,
            escaneoId: this.#escaneo_id,
            escaneo_id: this.#escaneo_id,
            tipo_id: vulnerabilityType ? {
                _id: vulnerabilityType._id,
                nombre: vulnerabilityType.nombre,
                descripcion: vulnerabilityType.descripcion
            } : null,
            nivel_severidad_id: severityLevel ? {
                _id: severityLevel._id,
                nombre: severityLevel.nombre,
                nivel: severityLevel.nivel,
                color: severityLevel.color
            } : null,
            parametro_afectado: this.#parametro_afectado, 
            url_afectada: this.#url_afectada, 
            descripcion: this.#descripcion, 
            sugerencia: this.#sugerencia,
            referencia: this.#referencia, 
            riskScore: this.getRiskScore(severityLevel, vulnerabilityType), 
            priority: this.getPriority(severityLevel),
            cvssScore: this.getCVSSScore(severityLevel), 
            isCritical: this.isCritical(severityLevel) 
        };
    }
    toString() { return `[VULN] ${this.#parametro_afectado || 'N/A'} @ ${this.#url_afectada || 'N/A'}`; }
}

function validateVulnerability(vuln) {
    return Vulnerability.validate(vuln);
}

exports.Vulnerability = Vulnerability;
exports.validate = validateVulnerability;
